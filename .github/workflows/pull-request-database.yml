name: Pull Request - Database Tests

on:
  pull_request:

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      database: ${{ steps.filter.outputs.database }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            database:
              - 'supabase/migrations/**'
              - 'tests/rls/**'
              - 'tests/auth/**'

  pull-request-database:
    needs: check-changes
    if: needs.check-changes.outputs.database == 'true'
    runs-on: ubuntu-latest
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Wait for Supabase Preview
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait_for_preview
        with:
          checkName: "Supabase Preview"
          ref: ${{ github.event.pull_request.head.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}
          timeoutSeconds: 300

      - name: Get Branch Credentials
        if: steps.wait_for_preview.outputs.conclusion == 'success'
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
          echo "=== Raw CLI output (redacted) ==="
          supabase --experimental branches get "$GITHUB_HEAD_REF" -o env | sed 's/=.*/=***/'
          echo "=== End raw output ==="
          # Parse and clean CLI output - remove quotes and trim whitespace
          while IFS='=' read -r key value; do
            # Remove surrounding quotes if present
            clean_value=$(echo "$value" | sed 's/^"//;s/"$//' | tr -d '\r')
            echo "${key}=${clean_value}" >> $GITHUB_ENV
            # Alias legacy ANON_KEY to new PUBLISHABLE name (branches get uses old names)
            if [ "$key" = "SUPABASE_ANON_KEY" ]; then
              echo "SUPABASE_PUBLISHABLE_DEFAULT_KEY=${clean_value}" >> $GITHUB_ENV
            fi
          done < <(supabase --experimental branches get "$GITHUB_HEAD_REF" -o env)

      - name: Debug Branch Info
        if: steps.wait_for_preview.outputs.conclusion == 'success'
        run: |
          echo "Branch: $GITHUB_HEAD_REF"
          echo "SUPABASE_URL value: '${SUPABASE_URL:0:30}...'"
          echo "SUPABASE_URL set: ${{ env.SUPABASE_URL != '' }}"
          echo "SUPABASE_SERVICE_ROLE_KEY set: ${{ env.SUPABASE_SERVICE_ROLE_KEY != '' }}"

      - name: Install dependencies
        run: bun install

      - name: Switch to and seed preview branch
        if: steps.wait_for_preview.outputs.conclusion == 'success'
        run: |
          # Unlink (ignore errors - keyring not available on CI)
          supabase unlink || true

          # Parse project-ref from SUPABASE_URL
          # https://<projectid>.supabase.co -> projectid
          PREVIEW_REF=$(echo "$SUPABASE_URL" | sed 's|https://||' | sed 's|\.supabase\.co.*||')
          echo "Preview project-ref: $PREVIEW_REF"

          # Validate PREVIEW_REF is not empty
          if [ -z "$PREVIEW_REF" ]; then
            echo "::error::Failed to parse PREVIEW_REF from SUPABASE_URL: $SUPABASE_URL"
            exit 1
          fi

          # Link to preview branch (will fail if invalid)
          if ! supabase link --project-ref "$PREVIEW_REF"; then
            echo "::error::Failed to link to preview branch: $PREVIEW_REF"
            exit 1
          fi

          # Push and seed
          supabase db push --include-seed --yes

      - name: Run RLS tests
        if: steps.wait_for_preview.outputs.conclusion == 'success'
        run: bun test rls

      - name: Run Auth tests
        if: steps.wait_for_preview.outputs.conclusion == 'success'
        run: bun test auth

      - name: Skip notice
        if: steps.wait_for_preview.outputs.conclusion != 'success'
        run: echo "Supabase Preview not available, skipping database tests"
